<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN Memory ç›£æ§ V12</title>
    <style>
        body { background: #0b1120; color: #f1f5f9; font-family: -apple-system, sans-serif; padding: 12px; margin: 0; }
        .card { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; position: relative; }
        .alert-card { border: 2px solid #10b981; background: #064e3b; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        label { display: block; font-size: 13px; color: #38bdf8; margin-bottom: 4px; margin-top: 10px; font-weight: bold; }
        input { background: #0f172a; border: 1px solid #475569; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: #38bdf8; color: #0b1120; border: none; padding: 18px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 18px; margin-top: 20px; }
        .ticker-row { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; padding: 12px 0; border-bottom: 1px solid #334155; font-size: 12px; align-items: center; }
        .badge { font-size: 9px; padding: 2px 4px; border-radius: 4px; border: 1px solid #475569; color: #94a3b8; display: inline-block; margin-top: 2px; }
        .refresh-btn { background: #0f172a; color: #38bdf8; border: 1px solid #38bdf8; font-size: 11px; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .lock-status { color: #10b981; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>
    <h3 style="color:#38bdf8; text-align:center; margin-bottom:20px;">ğŸ›¡ï¸ FCN è¨˜æ†¶ç›£æ§ (å¼·æ•ˆé€£ç·šç‰ˆ)</h3>
    <div class="card">
        <strong>â• éŒ„å…¥é‚±å§å–® (DSNT66029)</strong>
        <label>å®¢æˆ¶åç¨± / ç”¢å“ç·¨è™Ÿ</label><input type="text" id="c" placeholder="é‚±å§ DSNT66029">
        <div style="display:flex; gap:8px;">
            <div style="flex:1"><label>KO %</label><input type="number" id="k" value="95"></div>
            <div style="flex:1"><label>Strike %</label><input type="number" id="s" value="75"></div>
            <div style="flex:1"><label>KI %</label><input type="number" id="ki" value="55"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>å¹´åŒ–åˆ©ç‡ %</label><input type="number" id="rate" value="16.48"></div>
            <div style="flex:1"><label>åˆ°æœŸæ—¥</label><input type="date" id="mDate"></div>
        </div>
        <label>æ¯”åƒ¹èµ·å§‹æ—¥ (Memory Start)</label><input type="date" id="obs">
        <div style="background:#0f172a; padding:10px; border-radius:8px; margin-top:10px;">
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="tn" placeholder="MU"><input type="number" class="ti"></div>
            <div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="tn" placeholder="VST"><input type="number" class="ti"></div>
            <div style="display:flex; gap:5px;"><input type="text" class="tn" placeholder="WDC"><input type="number" class="ti"></div>
        </div>
        <button class="btn-main" onclick="save()">ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹å¼·æ•ˆç›£æ§</button>
    </div>
    <div id="list"></div>

<script>
    function nCDF(x){var t=1/(1+0.2315419*Math.abs(x));var d=0.3989423*Math.exp(-x*x/2);var p=d*t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274))));return(x>0)?(1-p):p;}
    function getP(S,H,v,d){if(!S||!H||S>=H)return 100;var T=d/365,sig=v/100;var d2=(Math.log(H/S)-(-0.5*sig*sig)*T)/(sig*Math.sqrt(T));return(2*(1-nCDF(d2))*100).toFixed(1);}

    let db = JSON.parse(localStorage.getItem('fcn_v12_db') || '[]');

    async function save() {
        const tn = document.querySelectorAll('.tn'), ti = document.querySelectorAll('.ti');
        let ts = [];
        tn.forEach((n, i) => { if(n.value) ts.push({ n: n.value.trim().toUpperCase(), i: ti[i].value, c: 0, p: 0, m_ok: false }); });
        db.push({ id: Date.now(), c: document.getElementById('c').value, k: document.getElementById('k').value, s: document.getElementById('s').value, ki: document.getElementById('ki').value, rate: document.getElementById('rate').value, m: document.getElementById('mDate').value, o: document.getElementById('obs').value, ts: ts });
        localStorage.setItem('fcn_v12_db', JSON.stringify(db));
        location.reload();
    }

    async function refreshOne(id) {
        const order = db.find(x => x.id === id);
        const today = new Date(); today.setHours(0,0,0,0);
        const days = Math.max(1, (new Date(order.m) - today)/86400000);
        
        for (let t of order.ts) {
            try {
                // åŠ å…¥éš¨æ©Ÿåƒæ•¸é¿å…å¿«å–å•é¡Œ
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${t.n}?interval=1d&range=1d&t=${Date.now()}`);
                const data = await res.json();
                const q = data.chart.result[0].indicators.quote[0];
                const lastPrice = q.close[q.close.length - 1] || q.open[q.open.length - 1];
                t.c = lastPrice.toFixed(2);
                
                const kP = t.i * (order.k / 100);
                const oS = new Date(order.o); oS.setHours(0,0,0,0);
                if (t.m_ok || (today >= oS && parseFloat(t.c) >= kP)) { t.m_ok = true; t.p = 100; }
                else { t.p = getP(t.c, kP, 30, days); }
            } catch(e) { t.c = "é€£ç·šä¸­.."; }
        }
        localStorage.setItem('fcn_v12_db', JSON.stringify(db));
        render();
    }

    function render() {
        document.getElementById('list').innerHTML = db.map(o => `
            <div class="card ${o.ts.every(t=>t.m_ok) ? 'alert-card' : ''}">
                <div style="display:flex; justify-content:space-between">
                    <div><strong>ğŸ‘¤ ${o.c}</strong><br><small style="color:#94a3b8;">åˆ©ç‡: ${o.rate}% | åˆ°æœŸ: ${o.m}</small></div>
                    <button class="refresh-btn" onclick="refreshOne(${o.id})">ğŸ”„ é»æ­¤é€£ç·š</button>
                </div>
                ${o.ts.map(t => `
                    <div class="ticker-row">
                        <span>${t.n}<br><span class="badge">S:${(t.i*(o.s/100)).toFixed(1)}</span></span>
                        <span style="text-align:center">æ”¶ç›¤: ${t.c || '---'}</span>
                        <span style="text-align:right;">${t.m_ok ? '<span class="lock-status">å·²è¨˜æ†¶</span>' : t.p+'%'}</span>
                    </div>
                `).join('')}
                <button style="background:none;border:none;color:#475569;font-size:10px;text-decoration:underline;margin-top:10px;width:100%;text-align:right" onclick="rem(${o.id})">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>`).join('');
    }
    function rem(id){ if(confirm('åˆªé™¤ï¼Ÿ')){db=db.filter(x=>x.id!==id); localStorage.setItem('fcn_v12_db', JSON.stringify(db)); render(); }}
    render();
</script>
</body>
</html>
