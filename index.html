<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN å°ˆæ¥­ç›£æ§çµ‚ç«¯ V7</title>
    <style>
        body { background: #0b1120; color: #f1f5f9; font-family: -apple-system, sans-serif; padding: 12px; margin: 0; }
        .card { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; }
        .alert-card { border: 2px solid #10b981; background: #064e3b; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .warning-card { border: 2px solid #f59e0b; }
        label { display: block; font-size: 13px; color: #38bdf8; margin-bottom: 4px; margin-top: 10px; font-weight: bold; }
        input { background: #0f172a; border: 1px solid #475569; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
        .btn-add { background: #38bdf8; color: #0b1120; border: none; padding: 16px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; margin-top: 20px; }
        .ticker-group { background: #0f172a; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #1e293b; }
        .ticker-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 10px 0; border-bottom: 1px solid #1e293b; font-size: 12px; align-items: center; }
        .del-btn { background: none; border: none; color: #475569; font-size: 11px; text-decoration: underline; margin-top: 10px; width: 100%; text-align: right; }
        .badge-ki { color: #f87171; font-size: 10px; border: 1px solid #ef4444; padding: 1px 4px; border-radius: 4px; display: inline-block; margin-top: 2px; }
    </style>
</head>
<body>
    <h3 style="color:#38bdf8; text-align:center; margin-bottom:20px;">ğŸ›¡ï¸ FCN æ™ºèƒ½ç›£æ§ (å…¨åŠŸèƒ½ç‰ˆ)</h3>
    
    <div class="card">
        <strong style="font-size:18px;">â• éŒ„å…¥æ–°åˆç´„</strong>
        <label>ç”¢å“ç·¨è™Ÿ / å®¢æˆ¶åç¨±</label>
        <input type="text" id="c" placeholder="ä¾‹å¦‚ï¼šDSNT72508">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>KO è§¸ç™¼ %</label><input type="number" id="k" value="100"></div>
            <div style="flex:1"><label>KI ä¸‹é™ % (é¸å¡«)</label><input type="number" id="ki_pct" placeholder="ç„¡ KI å‰‡ç•™ç©º"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>å¹´åŒ–åˆ©ç‡ %</label><input type="number" id="rate" placeholder="19.73"></div>
            <div style="flex:1"><label>æœ€çµ‚åˆ°æœŸæ—¥</label><input type="date" id="m"></div>
        </div>
        <label>é¦–å€‹è§€å¯ŸæœŸçµæŸæ—¥ (æ¯”åƒ¹èµ·å§‹æ—¥)</label>
        <input type="date" id="common_obs">
        <div class="ticker-group">
            <div style="color:#94a3b8; font-size:12px; margin-bottom:10px;">è«‹è¼¸å…¥é€£çµæ¨™çš„èˆ‡æœŸåˆåƒ¹ï¼š</div>
            <div style="display:flex; gap:8px; margin-bottom:10px;"><input type="text" class="tn" placeholder="ä»£ç¢¼ 1"><input type="number" class="ti" placeholder="æœŸåˆåƒ¹ 1"></div>
            <div style="display:flex; gap:8px; margin-bottom:10px;"><input type="text" class="tn" placeholder="ä»£ç¢¼ 2"><input type="number" class="ti" placeholder="æœŸåˆåƒ¹ 2"></div>
            <div style="display:flex; gap:8px;"><input type="text" class="tn" placeholder="ä»£ç¢¼ 3"><input type="number" class="ti" placeholder="æœŸåˆåƒ¹ 3"></div>
        </div>
        <button class="btn-add" onclick="save()">ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹æ¯æ—¥æ¯”åƒ¹ç›£æ§</button>
    </div>
    <div id="list"></div>

<script>
    function nCDF(x){var t=1/(1+0.2315419*Math.abs(x));var d=0.3989423*Math.exp(-x*x/2);var p=d*t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274))));return(x>0)?(1-p):p;}
    function getP(S,H,v,d){if(!S||!H||S>=H)return 100;var T=d/365,sig=v/100;var d2=(Math.log(H/S)-(-0.5*sig*sig)*T)/(sig*Math.sqrt(T));return(2*(1-nCDF(d2))*100).toFixed(1);}

    let db = JSON.parse(localStorage.getItem('fcn_v7_final') || '[]');

    async function save() {
        const tn = document.querySelectorAll('.tn'), ti = document.querySelectorAll('.ti');
        const obs = document.getElementById('common_obs').value;
        let ts = [];
        tn.forEach((n, i) => { if(n.value) ts.push({ n: n.value.toUpperCase(), i: ti[i].value, o: obs, c: 0, ko: false, p: 0 }); });
        db.push({ id: Date.now(), c: document.getElementById('c').value, k: document.getElementById('k').value, ki: document.getElementById('ki_pct').value, rate: document.getElementById('rate').value, m: document.getElementById('m').value, ts: ts });
        localStorage.setItem('fcn_v7_final', JSON.stringify(db));
        location.reload();
    }

    async function refresh() {
        const today = new Date(); today.setHours(0,0,0,0);
        for (let o of db) {
            const mD = new Date(o.m);
            const days = Math.max(1, (mD - today)/86400000);
            for (let t of o.ts) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${t.n}?interval=1d&range=1d`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const price = data.chart.result[0].indicators.quote[0].close[0];
                    t.c = price ? price.toFixed(2) : "---";
                    const kPrice = t.i * (o.k / 100);
                    const oStart = new Date(t.o); oStart.setHours(0,0,0,0);
                    if (today >= oStart && parseFloat(t.c) >= kPrice) { t.ko = true; t.p = 100; }
                    else { t.ko = false; t.p = getP(t.c, kPrice, 30, days); }
                    t.ki_val = o.ki ? (t.i * (o.ki / 100)).toFixed(2) : null;
                } catch(e) { t.c = "---"; }
            }
        }
        localStorage.setItem('fcn_v7_final', JSON.stringify(db));
        render();
    }

    function render() {
        db.sort((a,b) => Math.max(...b.ts.map(t=>t.p)) - Math.max(...a.ts.map(t=>t.p)));
        document.getElementById('list').innerHTML = db.map(o => {
            const isAllKO = o.ts.every(t => t.ko);
            const maxP = Math.max(...o.ts.map(t => t.p));
            return `
                <div class="card ${isAllKO ? 'alert-card' : (maxP > 80 ? 'warning-card' : '')}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div><strong>ğŸ‘¤ ${o.c}</strong><br><span style="font-size:11px; color:#94a3b8;">å¹´åŒ–åˆ©ç‡: ${o.rate}% | åˆ°æœŸ: ${o.m}</span></div>
                        <span style="font-size:12px; font-weight:bold; color:${isAllKO ? '#10b981' : (maxP > 80 ? '#fbbf24' : '#38bdf8')}">${isAllKO ? 'âœ… å·²è´–å›' : 'é ä¼°æ©Ÿç‡: ' + maxP + '%'}</span>
                    </div>
                    ${o.ts.map(t => `
                        <div class="ticker-row">
                            <span>${t.n} ${t.ki_val ? `<br><span class="badge-ki">KI: ${t.ki_val}</span>` : ''}</span>
                            <span style="text-align:center">ç¾åƒ¹: ${t.c}</span>
                            <span style="text-align:right; font-weight:bold; color:${t.ko ? '#10b981' : (t.p > 80 ? '#fbbf24' : '#38bdf8')}">${t.ko ? 'å·²é”æ¨™' : t.p+'%'}</span>
                        </div>
                    `).join('')}
                    <button class="del-btn" onclick="rem(${o.id})">ğŸ—‘ï¸ åˆªé™¤åˆç´„</button>
                </div>
            `;
        }).join('');
    }
    function rem(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { db = db.filter(x=>x.id!==id); localStorage.setItem('fcn_v7_final', JSON.stringify(db)); render(); } }
    refresh();
</script>
</body>
</html>
