<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCN Memory DKO çµ‚æ¥µçµ‚ç«¯</title>
    <style>
        body { background: #0b1120; color: #f1f5f9; font-family: -apple-system, sans-serif; padding: 12px; margin: 0; }
        .card { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; position: relative; }
        .alert-card { border: 2px solid #10b981; background: #064e3b; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .warning-card { border: 2px solid #f59e0b; }
        label { display: block; font-size: 13px; color: #38bdf8; margin-bottom: 4px; margin-top: 10px; font-weight: bold; }
        input { background: #0f172a; border: 1px solid #475569; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
        .btn-main { background: #38bdf8; color: #0b1120; border: none; padding: 18px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 18px; margin-top: 20px; }
        .ticker-group { background: #0f172a; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #1e293b; }
        .ticker-row { display: grid; grid-template-columns: 1fr 1fr 1.2fr; gap: 8px; padding: 12px 0; border-bottom: 1px solid #334155; font-size: 12px; align-items: center; }
        .badge { font-size: 9px; padding: 2px 4px; border-radius: 4px; border: 1px solid #475569; color: #94a3b8; display: inline-block; margin-top: 2px; }
        .stk { border-color: #38bdf8; color: #38bdf8; }
        .ki { border-color: #f87171; color: #f87171; }
        .refresh-btn { background: #0f172a; color: #38bdf8; border: 1px solid #38bdf8; font-size: 11px; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .del-btn { background: none; border: none; color: #475569; font-size: 11px; text-decoration: underline; margin-top: 12px; width: 100%; text-align: right; }
        .lock-status { color: #10b981; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>
    <h3 style="color:#38bdf8; text-align:center; margin-bottom:20px;">ğŸ›¡ï¸ FCN è¨˜æ†¶æ©Ÿåˆ¶ç›£æ§ç³»çµ±</h3>
    
    <div class="card">
        <strong style="font-size:18px;">â• éŒ„å…¥é‚±å§åˆç´„ (DSNT66029)</strong>
        <label>å®¢æˆ¶åç¨± / ç”¢å“ç·¨è™Ÿ</label>
        <input type="text" id="c" placeholder="ä¾‹å¦‚ï¼šé‚±å§ DSNT66029">
        
        <div style="display:flex; gap:8px;">
            <div style="flex:1"><label>è§¸ç™¼ (KO) %</label><input type="number" id="k" value="95"></div>
            <div style="flex:1"><label>åŸ·è¡Œ (Strike) %</label><input type="number" id="s" value="75"></div>
            <div style="flex:1"><label>ä¸‹é™ (KI) %</label><input type="number" id="ki" value="55"></div>
        </div>

        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>å¹´åŒ–åˆ©ç‡ %</label><input type="number" id="rate" value="16.48"></div>
            <div style="flex:1"><label>æœ€çµ‚åˆ°æœŸæ—¥</label><input type="date" id="mDate"></div>
        </div>
        
        <label>é¦–å€‹è§€å¯ŸæœŸçµæŸæ—¥ (æ¯”åƒ¹èµ·å§‹æ—¥)</label>
        <input type="date" id="obs">

        <div class="ticker-group">
            <div style="color:#94a3b8; font-size:11px; margin-bottom:10px;">è«‹è¼¸å…¥æ¨™çš„ä»£ç¢¼èˆ‡æœŸåˆåƒ¹ï¼š</div>
            <div style="display:flex; gap:8px; margin-bottom:8px;"><input type="text" class="tn" placeholder="MU"><input type="number" class="ti" placeholder="220.1"></div>
            <div style="display:flex; gap:8px; margin-bottom:8px;"><input type="text" class="tn" placeholder="VST"><input type="number" class="ti" placeholder="199.3"></div>
            <div style="display:flex; gap:8px;"><input type="text" class="tn" placeholder="WDC"><input type="number" class="ti" placeholder="126.67"></div>
        </div>

        <button class="btn-main" onclick="save()">ğŸ’¾ å„²å­˜ä¸¦å•Ÿå‹• Memory ç›£æ§</button>
    </div>

    <div id="list"></div>

<script>
    function nCDF(x){var t=1/(1+0.2315419*Math.abs(x));var d=0.3989423*Math.exp(-x*x/2);var p=d*t*(0.3193815+t*(-0.3565638+t*(1.781478+t*(-1.821256+t*1.330274))));return(x>0)?(1-p):p;}
    function getP(S,H,v,d){if(!S||!H||S>=H)return 100;var T=d/365,sig=v/100;var d2=(Math.log(H/S)-(-0.5*sig*sig)*T)/(sig*Math.sqrt(T));return(2*(1-nCDF(d2))*100).toFixed(1);}

    let db = JSON.parse(localStorage.getItem('fcn_memory_v11_db') || '[]');

    async function save() {
        const tn = document.querySelectorAll('.tn'), ti = document.querySelectorAll('.ti');
        let ts = [];
        tn.forEach((n, i) => { if(n.value) ts.push({ n: n.value.toUpperCase(), i: ti[i].value, c: 0, p: 0, m_ok: false }); });
        db.push({ id: Date.now(), c: document.getElementById('c').value, k: document.getElementById('k').value, s: document.getElementById('s').value, ki: document.getElementById('ki').value, rate: document.getElementById('rate').value, m: document.getElementById('mDate').value, o: document.getElementById('obs').value, ts: ts });
        localStorage.setItem('fcn_memory_v11_db', JSON.stringify(db));
        location.reload();
    }

    async function refreshOne(id) {
        const order = db.find(x => x.id === id);
        const today = new Date(); today.setHours(0,0,0,0);
        const days = Math.max(1, (new Date(order.m) - today)/86400000);
        
        for (let t of order.ts) {
            try {
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${t.n}?interval=1d&range=1d`);
                const data = await res.json();
                const q = data.chart.result[0].indicators.quote[0];
                t.c = (q.close[0] || q.open[0]).toFixed(2); // æŠ“æ”¶ç›¤åƒ¹
                
                const kP = t.i * (order.k / 100);
                const oS = new Date(order.o); oS.setHours(0,0,0,0);
                
                // è¨˜æ†¶æ©Ÿåˆ¶é‚è¼¯ï¼šä¸€æ—¦é”æ¨™çµ‚èº«ç¶ è‰²
                if (t.m_ok || (today >= oS && parseFloat(t.c) >= kP)) {
                    t.m_ok = true;
                    t.p = 100;
                } else {
                    t.p = getP(t.c, kP, 30, days);
                }
            } catch(e) { t.c = "---"; }
        }
        localStorage.setItem('fcn_memory_v11_db', JSON.stringify(db));
        render();
    }

    function render() {
        db.sort((a,b) => Math.max(...b.ts.map(t=>t.p)) - Math.max(...a.ts.map(t=>t.p)));
        document.getElementById('list').innerHTML = db.map(o => {
            const isAllKO = o.ts.every(t => t.m_ok);
            const maxP = Math.max(...o.ts.map(t => t.p));
            return `
            <div class="card ${isAllKO ? 'alert-card' : (maxP > 80 ? 'warning-card' : '')}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong>ğŸ‘¤ ${o.c}</strong><br>
                        <small style="color:#94a3b8;">åˆ©ç‡: ${o.rate}% | åˆ°æœŸ: ${o.m}</small>
                    </div>
                    <button class="refresh-btn" onclick="refreshOne(${o.id})">ğŸ”„ æŠ“æ”¶ç›¤åƒ¹</button>
                </div>
                ${o.ts.map(t => `
                    <div class="ticker-row">
                        <span>${t.n}<br>
                            <span class="badge stk">S: ${(t.i*(o.s/100)).toFixed(1)}</span> 
                            <span class="badge ki">KI: ${(t.i*(o.ki/100)).toFixed(1)}</span>
                        </span>
                        <span style="text-align:center">æ”¶ç›¤: ${t.c || '---'}</span>
                        <span style="text-align:right;">
                            ${t.m_ok ? '<span class="lock-status">å·²è¨˜æ†¶é–å®š</span>' : '<span style="color:#38bdf8;font-weight:bold;">'+t.p+'%</span>'}
                        </span>
                    </div>
                `).join('')}
                <button class="del-btn" onclick="rem(${o.id})">ğŸ—‘ï¸ åˆªé™¤åˆç´„</button>
            </div>`;
        }).join('');
    }
    function rem(id){ if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){db=db.filter(x=>x.id!==id); localStorage.setItem('fcn_memory_v11_db', JSON.stringify(db)); render(); }}
    render();
</script>
</body>
</html>
